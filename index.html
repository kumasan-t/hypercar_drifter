<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="./js/hand.minified-1.2.js"></script>
        <script src="./js/cannon.js"></script>  
        <script src="./js/babylon.js"></script>
        <script src="./js/direction.js"></script>
        <script src="./js/obstacles.js"></script>
        <script src="./js/planes.js"></script>
        <script src="./js/gameover.physics.js"></script>
        <script src="./js/gui.js"></script>
        <script src="./js/entities/barrel.js"></script>
        <script src="./js/entities/propeller.js"></script>
        
        <link href="./css/mainstyle.css" rel="stylesheet" type="text/css">

    </head>
    <body>
        <div id="container">
            <div id="counter">0</div>
            <div id="gameover">
                <div id="gameover-text">GAME OVER</div>
                <div id="speed-text">Speed: 120 m/s</div>
                <div id="distance-text">Distance: 1234.5 m</div>
            </div>
            <canvas id="renderCanvas"></canvas>
        </div>
        
        
        <script>
            var canvas = document.getElementById("renderCanvas");
            var engine = new BABYLON.Engine(canvas, false,null,false);
            var car;
            var carSpeed = 3;
            var obstacleSpeed = 1;
            var obstaclesManager;
            var planeManager = new Plane(-10, 50);
            var specularLight;
            
            var meshBarrel;
            var meshPropeller;
            var meshPlane;
            
            var globalTime = 0;
            
            var carLoaded = false;
            var barrelLoaded = false;
            var propellerLoaded = false;

            var keys = {
                left: 0,
                right: 0,
                up: 0,
                down: 0
            };
            window.addEventListener("keydown", handleKeyDown, false);
            window.addEventListener("keyup", handleKeyUp, false);
            function handleKeyDown(evt) {
                if (evt.keyCode == 65) {
                    //A        
                    keys.left = 1;
                }
                if (evt.keyCode == 68) {//D        
                    keys.right = 1;
                }
                if (evt.keyCode == 87){//W        
                    keys.up = 1;
                }
                if (evt.keyCode == 83) {//S        
                    keys.down = 1;
                }
                if (evt.keyCode == 88) {
                    obstacleSpeed = 0;
                    carSpeed = 0;
                    guiGameover();
                    gameover(car, planeManager.planeArray, obstaclesManager.obstacles_array,scene, 1 / engine.fps);
                
                }
            }

            function handleKeyUp(evt) {
                if (evt.keyCode == 65) {
                    keys.left = 0;
                }
                if (evt.keyCode == 68) {
                    keys.right = 0;
                }
                if (evt.keyCode == 87) {
                    keys.up = 0;
                }
                if (evt.keyCode == 83) {
                    keys.down = 0;
                }
            }

            var createScene = function () {
                var scene = new BABYLON.Scene(engine);
                
                guiMainMenu(scene);
                scene.clearColor = new BABYLON.Color3(.95, .95, .95);

                var light = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 1, 0), scene);
                light.groundColor = new BABYLON.Color3(0.5, 0, 0.5);
                light.intensity = 1;

                specularLight = new BABYLON.PointLight("Omni0", new BABYLON.Vector3(1, 10, -1), scene);
                specularLight.diffuseColor = new BABYLON.Color3(0, 0, 0);
                specularLight.specularColor = new BABYLON.Color3(1, 1, 1);
                specularLight.range = 10;
                specularLight.intensity = 10;
                BABYLON.SceneLoader.ImportMesh("", "assets/", "supercar.babylon", scene, function (meshes) {
                    car = meshes[0];
                    BABYLON.SceneLoader.ImportMesh("", "assets/", "sottocar.babylon", scene, function (bottom) {
                        bottom[0].parent = car;
                        bottom[0].position.x = 1.1;
                        bottom[0].position.z = 0;
                        bottom[0].material = new BABYLON.StandardMaterial("", scene);
                        bottom[0].material.diffuseColor = new BABYLON.Color3(.05, .05, .05);
                        bottom[0].material.specularColor = new BABYLON.Color3(0, 0, 0);
                        car.rotation.y = -Math.PI / 2;
                        car.xDirection = 0;
                        car.yDirection = 0;
                        car.scaling = new BABYLON.Vector3(.125, .125, .125);
                        carLoaded = true;
                    });
                });

                var planeMaterial = loadPlaneMaterial(scene);
                BABYLON.SceneLoader.ImportMesh("", "assets/", "pianohuhu.babylon", scene, function (meshes) {
                    meshes[0].rotation.x = -Math.PI / 2;
                    meshes[0].scaling = new BABYLON.Vector3(2.5, 2.5, 2.5);
                    meshes[0].material = planeMaterial;
                    meshes[0].isVisible = false;
                    meshPlane = meshes[0];
                    planeManager.spawn(scene);
                });

                BABYLON.SceneLoader.ImportMesh("", "assets/", "barilenitro.babylon", scene, function (meshes) {
                    meshBarrel = meshes[0];
                    meshBarrel.type = "nitro_barrel";
                    meshBarrel.position.z = -15;
                    barrelLoaded = true;
                });

                BABYLON.SceneLoader.ImportMesh("", "assets/", "ventola.babylon", scene, function (meshes) {
                    meshPropellers = meshes[0];
                    meshPropellers.type = "propeller";
                    meshPropellers.isVisible = false;
                    propellerLoaded = true;
                });

                obstaclesManager = new Obstacles(-15);

                scene.fogMode = BABYLON.Scene.FOGMODE_LINEAR;
                scene.fogColor = new BABYLON.Color3(0.9, 0.9, 0.9);
                scene.fogDensity = 1;
                scene.fogStart = 10.0;
                scene.fogEnd = 50.0;

                return scene;
            };

            var scene = createScene();

            
            var camera = new BABYLON.FreeCamera("FreeCamera", new BABYLON.Vector3(0, 0, -2.5), scene);

            var frameCount = 0;
            engine.runRenderLoop(function () {
                if (frameCount % 60 == 0){
                    //console.log(engine.fps);
                    console.log("Obstacle speed: " + obstacleSpeed);
                }
                frameCount++;
                globalTime += 1/engine.fps;
                document.getElementById("counter").innerHTML = engine.fps.toFixed(2);
                if(obstacleSpeed > 0)
                    obstacleSpeed = 3 + 12*(1-Math.exp(-0.01 * globalTime));
                
                if (carLoaded & barrelLoaded & propellerLoaded) {
                    var xMovement = 0, yMovement = 0;
                    if (keys.left == 1)
                        xMovement += 1;
                    if (keys.right == 1)
                        xMovement -= 1;
                    if (keys.up == 1)
                        yMovement += 1;
                    if (keys.down == 1)
                        yMovement -= 1;
                    if(carSpeed > 0)
                        updateRotation(car, 1 / engine.fps, xMovement, yMovement);
                    
                    if(carSpeed > 0){
                    car.position.x -= carSpeed / engine.fps * car.xDirection;
                    car.position.y += carSpeed / engine.fps * car.yDirection;

                    if (car.position.x > 1) {
                        car.position.x = 1;
                    }
                    if (car.position.y > .5) {
                        car.position.y = .5;
                    }
                    if (car.position.x < -1) {
                        car.position.x = -1;
                    }

                    if (car.position.y < -.5) {
                        car.position.y = -.5;
                    }
                }
                    specularLight.position.x = car.position.x * 4;
                    specularLight.position.y = car.position.y * 4;
                    if(obstacleSpeed > 0) {
                        
                        obstaclesManager.update(obstacleSpeed, 1/engine.fps);
                        obstaclesManager.despawn();
                        obstaclesManager.spawn(scene, 1/engine.fps);
                    
                        planeManager.update(obstacleSpeed, 1/engine.fps);
                    }
                    
                    scene.render();
                }
            });

            window.addEventListener("resize", function () {
                engine.resize();
            });

            function loadPlaneMaterial(scene) {
                var material = new BABYLON.StandardMaterial('a', scene);
                material.alpha = 1;
                material.backFaceCulling = true;
                material.specularPower = 64;
                material.useSpecularOverAlpha = true;
                material.useAlphaFromDiffuseTexture = false;

                //Diffuse definitions;
                var material_diffuseTexture = new BABYLON.Texture('assets/pianospritep.png', scene);
                material_diffuseTexture.uScale = 1;
                material_diffuseTexture.vScale = 1;
                material_diffuseTexture.coordinatesMode = 0;
                material_diffuseTexture.uOffset = 0;
                material_diffuseTexture.vOffset = 0;
                material_diffuseTexture.uAng = 0;
                material_diffuseTexture.vAng = 0;
                material_diffuseTexture.level = 1;
                material_diffuseTexture.coordinatesIndex = 0;
                material_diffuseTexture.hasAlpha = false;
                material_diffuseTexture.getAlphaFromRGB = false;
                material.diffuseTexture = material_diffuseTexture;
                material.diffuseColor = new BABYLON.Color3(1.00, 1.00, 1.00);

                //Emissive definitions;

                material.emissiveColor = new BABYLON.Color3(0.04, 0.99, 0.76);

                //Texture parameters ;
                var material_emissiveTexture = new BABYLON.Texture('assets/pianosprites2.png', scene);
                material_emissiveTexture.uScale = 1;
                material_emissiveTexture.vScale = 1;
                material_emissiveTexture.coordinatesMode = 0;
                material_emissiveTexture.uOffset = 0;
                material_emissiveTexture.vOffset = 0;
                material_emissiveTexture.uAng = 0;
                material_emissiveTexture.vAng = 0;
                material_emissiveTexture.level = 1;
                material_emissiveTexture.coordinatesIndex = 0;
                material_emissiveTexture.hasAlpha = false;
                material_emissiveTexture.getAlphaFromRGB = false;
                material.emissiveTexture = material_emissiveTexture;

                //Ambient definitions;
                material.ambientColor = new BABYLON.Color3(0.00, 0.00, 0.00);

                //Specular definitions;
                material.specularColor = new BABYLON.Color3(1.00, 1.00, 1.00);

                //Specular texture Parameters ;
                var material_specularTexture = new BABYLON.Texture('assets/pianosprites2.png', scene);
                material_specularTexture.uScale = 1;
                material_specularTexture.vScale = 1;
                material_specularTexture.coordinatesMode = 0;
                material_specularTexture.uOffset = 0;
                material_specularTexture.vOffset = 0;
                material_specularTexture.uAng = 0;
                material_specularTexture.vAng = 0;
                material_specularTexture.level = 1;
                material_specularTexture.coordinatesIndex = 0;
                material_specularTexture.hasAlpha = false;
                material_specularTexture.getAlphaFromRGB = false;
                material.specularTexture = material_specularTexture;

                material.freeze();
                return material;
            }
        </script>
    </body>
</html>
